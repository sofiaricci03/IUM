@model Template.Web.Areas.Responsabile.Controllers.CongedoViewModel
@{
    ViewData["Title"] = "Congedo – Responsabile";
}

@section pageTitle {
    <div class="onit-page-title">
        <h1><i class="fa-solid fa-plane-departure"></i> Congedo</h1>
    </div>
}

<div class="container-fluid onit-page-content">
    <div class="row">

        <!-- SIDEBAR -->
        <div class="col-2 onit-sidebar">
            <ul class="onit-sidebar-menu">
                <li>
                    <a asp-area="Responsabile" asp-controller="Dashboard" asp-action="Index">
                        <i class="fa-solid fa-calendar-check"></i> Attività
                    </a>
                </li>
                <li>
                    <a asp-area="Responsabile" asp-controller="Progetti" asp-action="Index">
                        <i class="fa-solid fa-diagram-project"></i> Progetti
                    </a>
                </li>
                <li>
                    <a asp-area="Responsabile" asp-controller="Rendicontazione" asp-action="Index">
                        <i class="fa-solid fa-clipboard-list"></i> Rendicontazione
                    </a>
                </li>
                <li>
                    <a class="active" asp-area="Responsabile" asp-controller="Congedo" asp-action="Index">
                        <i class="fa-solid fa-plane-departure"></i> Congedo
                    </a>
                </li>
                <li>
                    <a asp-area="Responsabile" asp-controller="Contratto" asp-action="Index">
                        <i class="fa-solid fa-file-contract"></i> Contratto
                    </a>
                </li>
                 <li>
                    <a asp-area="Responsabile"
                    asp-controller="Fatturazione"
                    asp-action="Index">
                        <i class="fa-solid fa-receipt"></i> Fatturazione
                    </a>
                </li>
            </ul>
        </div>

        <!-- MAIN CONTENT -->
        <div class="col-10">

            <!-- TABS -->
            <ul class="nav nav-tabs mb-4" id="congedoTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="approvazioni-tab" data-bs-toggle="tab"
                            data-bs-target="#approvazioni" type="button" role="tab">
                        <i class="fa-solid fa-clipboard-check"></i> Approvazioni
                        <span class="badge bg-danger ms-2" id="badgeDaApprovare" style="display:none;">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="calendario-tab" data-bs-toggle="tab"
                            data-bs-target="#calendario" type="button" role="tab">
                        <i class="fa-solid fa-calendar"></i> Calendario aziendale
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="mieferie-tab" data-bs-toggle="tab"
                            data-bs-target="#mieferie" type="button" role="tab">
                        <i class="fa-solid fa-user"></i> Le mie ferie
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="congedoTabContent">

                <!-- TAB 1: APPROVAZIONI -->
                <div class="tab-pane fade show active" id="approvazioni" role="tabpanel">
                    <div class="onit-toolbar d-flex justify-content-between align-items-center mb-3">
                        <h3 class="fw-bold mb-0">Richieste da approvare</h3>
                    </div>
                    <div id="listaApprovazioni">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Caricamento...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: CALENDARIO AZIENDALE -->
                <div class="tab-pane fade" id="calendario" role="tabpanel">
                    <div class="onit-card p-4">
                        <!-- Header con navigazione -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex align-items-center gap-2">
                                <button class="btn btn-sm btn-outline-secondary" id="btnPrevMonth">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </button>
                                <h4 class="mb-0 fw-bold" id="meseCorrente">Gennaio 2026</h4>
                                <button class="btn btn-sm btn-outline-secondary" id="btnNextMonth">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </button>
                            </div>
                            <div class="d-flex gap-3 align-items-center">
                                <span class="d-flex align-items-center gap-1">
                                    <span class="legenda-box" style="background-color: #28a745;"></span>
                                    <small>Ferie</small>
                                </span>
                                <span class="d-flex align-items-center gap-1">
                                    <span class="legenda-box" style="background-color: #ffc107;"></span>
                                    <small>Permesso</small>
                                </span>
                                <span class="d-flex align-items-center gap-1">
                                    <span class="legenda-box" style="background-color: #dc3545;"></span>
                                    <small>Malattia</small>
                                </span>
                            </div>
                        </div>
                        
                        <!-- Griglia calendario -->
                        <div class="table-responsive">
                            <table class="table table-bordered calendario-griglia" id="grigliaCalendario">
                                <thead>
                                    <tr id="headerGiorni">
                                        <th class="col-dipendente">Dipendente</th>
                                        <!-- Giorni generati dinamicamente -->
                                    </tr>
                                </thead>
                                <tbody id="bodyGriglia">
                                    <!-- Righe dipendenti generate dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB 3: LE MIE FERIE -->
                <div class="tab-pane fade" id="mieferie" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="fw-bold mb-0">Le mie ferie</h3>
                        <button class="btn btn-primary" id="btnNuovaRichiesta">
                            <i class="fa-solid fa-plus"></i> Nuova richiesta
                        </button>
                    </div>
                    <div class="onit-card p-3">
                        <div id="calendarioMio" style="min-height:500px;"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- MODALE APPROVA/RESPINGI -->
<div class="modal fade" id="modaleApprova" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content onit-card">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fa-solid fa-clipboard-check"></i> Dettaglio richiesta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="requestId">
                <div class="mb-3 d-flex align-items-center gap-3">
                    <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center text-white"
                         style="width:50px; height:50px; font-size:1.2rem;">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div>
                        <h5 class="mb-0" id="modaleDipendente"></h5>
                        <small class="text-muted" id="modaleTipo"></small>
                    </div>
                </div>
                <hr>
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="fw-bold text-muted small">Dal</label>
                        <p class="mb-0" id="modaleDal">-</p>
                    </div>
                    <div class="col-6">
                        <label class="fw-bold text-muted small">Al</label>
                        <p class="mb-0" id="modaleAl">-</p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="fw-bold text-muted small">Giorni</label>
                        <p class="mb-0" id="modaleGiorni">-</p>
                    </div>
                    <div class="col-6">
                        <label class="fw-bold text-muted small">Data richiesta</label>
                        <p class="mb-0" id="modaleDataRichiesta">-</p>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="fw-bold text-muted small">Motivo</label>
                    <p class="mb-0" id="modaleMotivo">-</p>
                </div>
                <div id="noteContainer" class="d-none mt-3">
                    <label class="fw-bold text-muted small">Note respingimento (obbligatorio)</label>
                    <textarea id="noteRespingimento" class="form-control" rows="2" placeholder="Motivo del respingimento..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-danger" id="btnRespingi">
                    <i class="fa-solid fa-xmark"></i> Respingi
                </button>
                <button type="button" class="btn btn-success" id="btnApprova">
                    <i class="fa-solid fa-check"></i> Approva
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODALE NUOVA RICHIESTA -->
<div class="modal fade" id="modaleCrea" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content onit-card">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fa-solid fa-plane-departure"></i> Nuova richiesta congedo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Tipo</label>
                    <div class="btn-group w-100" id="tipoGroup">
                        <button class="btn btn-outline-primary active" id="btnTipoFerie">
                            <i class="fa-solid fa-umbrella-beach"></i> Ferie
                        </button>
                        <button class="btn btn-outline-primary" id="btnTipoPermesso">
                            <i class="fa-solid fa-clock"></i> Permesso
                        </button>
                        <button class="btn btn-outline-primary" id="btnTipoMalattia">
                            <i class="fa-solid fa-virus"></i> Malattia
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Dal</label>
                    <input type="date" id="creaDal" class="form-control">
                </div>
                <div class="mb-3" id="alContainer">
                    <label class="form-label fw-bold">Al</label>
                    <input type="date" id="creaAl" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Motivo</label>
                    <textarea id="creaMotivo" class="form-control" rows="2" placeholder="Motivo della richiesta..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-primary" id="btnInviaRichiesta">
                    <i class="fa-solid fa-send"></i> Invia richiesta
                </button>
            </div>
        </div>
    </div>
</div>

@section styles {
<style>
    .badge-legenda {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    .badge-attesa { background-color: #fff3cd; color: #856404; }
    .badge-approvato { background-color: #d4edda; color: #155724; }

    .rend-card { transition: all 0.2s; cursor: pointer; }
    .rend-card:hover { transform: translateX(5px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }

    .fc .fc-event { border-radius: 4px; font-size: 0.8rem; padding: 2px 6px; cursor: pointer; }
    .fc-event-attesa { background-color: rgba(255,193,7,0.5) !important; border-color: #ffc107 !important; color: #856404 !important; }
    .fc-event-approvato { background-color: #28a745 !important; border-color: #28a745 !important; color: #fff !important; }
    
    /* Evidenzia weekend in grigio chiaro */
    .fc-day.weekend-day {
        background-color: #f8f9fa !important;
    }
    
    /* Colore leggermente più scuro per le celle header del weekend */
    .fc-col-header-cell.fc-day-sat,
    .fc-col-header-cell.fc-day-sun {
        background-color: #e9ecef !important;
    }
    
    /* Mantieni il giorno corrente visibile anche se cade nel weekend */
    .fc-daygrid-day.fc-day-today.weekend-day {
        background-color: #fff3cd !important;
    }

    /* Stili griglia calendario */
    .legenda-box {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        display: inline-block;
    }

    .calendario-griglia {
        font-size: 0.75rem;
        margin-bottom: 0;
    }

    .calendario-griglia th,
    .calendario-griglia td {
        text-align: center;
        vertical-align: middle;
        padding: 4px;
        min-width: 35px;
        height: 40px;
    }

    .calendario-griglia .col-dipendente {
        text-align: left;
        font-weight: 600;
        min-width: 220px;
        padding-left: 12px;
        padding-right: 12px;
        white-space: nowrap;
        position: sticky;
        left: 0;
        background-color: white;
        z-index: 10;
    }

    .calendario-griglia thead th {
        background-color: #f8f9fa;
        font-weight: 600;
        font-size: 0.7rem;
        position: sticky;
        top: 0;
        z-index: 5;
    }

    .calendario-griglia thead th.col-dipendente {
        z-index: 15;
    }

    .calendario-griglia .giorno-weekend {
        background-color: #f8f9fa;
    }

    .calendario-griglia .cella-evento {
        font-weight: bold;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        transition: transform 0.1s;
    }

    .calendario-griglia .cella-evento:hover {
        transform: scale(1.1);
    }

    .calendario-griglia .evento-ferie {
        background-color: #28a745;
    }

    .calendario-griglia .evento-permesso {
        background-color: #ffc107;
        color: #333;
    }

    .calendario-griglia .evento-malattia {
        background-color: #dc3545;
    }

    .table-responsive {
        max-height: 600px;
        overflow: auto;
    }
</style>
}

@section scripts {
<script>
(function() {
    var tipoCorrente = 'Ferie';
    var calendarMio = null;

    // ========================================
    // INIZIALIZZAZIONE
    // ========================================
    var grigliaCaridata = false;
    
    document.addEventListener('DOMContentLoaded', function() {
        caricaApprovazioni();

        document.getElementById('calendario-tab').addEventListener('shown.bs.tab', function() {
            if (!grigliaCaridata) {
                inizializzaCalendarioAziendale();
                grigliaCaridata = true;
            }
        });

        document.getElementById('mieferie-tab').addEventListener('shown.bs.tab', function() {
            setTimeout(function() {
                if (!calendarMio) {
                    inizializzaCalendarioMio();
                } else {
                    calendarMio.render();
                }
            }, 200);
        });

        document.getElementById('btnNuovaRichiesta').addEventListener('click', function() {
            apriModaleCrea();
        });

        document.getElementById('btnApprova').addEventListener('click', function() {
            approvaRichiesta();
        });

        document.getElementById('btnRespingi').addEventListener('click', function() {
            respingiRichiesta();
        });

        document.getElementById('btnTipoFerie').addEventListener('click', function() {
            tipoCorrente = 'Ferie';
            document.getElementById('btnTipoFerie').classList.add('active');
            document.getElementById('btnTipoPermesso').classList.remove('active');
            document.getElementById('btnTipoMalattia').classList.remove('active');
            document.getElementById('alContainer').style.display = 'block';
        });

        document.getElementById('btnTipoPermesso').addEventListener('click', function() {
            tipoCorrente = 'Permesso';
            document.getElementById('btnTipoPermesso').classList.add('active');
            document.getElementById('btnTipoFerie').classList.remove('active');
            document.getElementById('btnTipoMalattia').classList.remove('active');
            document.getElementById('alContainer').style.display = 'none';
        });

        document.getElementById('btnTipoMalattia').addEventListener('click', function() {
            tipoCorrente = 'Malattia';
            document.getElementById('btnTipoMalattia').classList.add('active');
            document.getElementById('btnTipoFerie').classList.remove('active');
            document.getElementById('btnTipoPermesso').classList.remove('active');
            document.getElementById('alContainer').style.display = 'block';
        });

        document.getElementById('btnTipoMalattia').addEventListener('click', function() {
            tipoCorrente = 'Malattia';
            document.getElementById('btnTipoMalattia').classList.add('active');
            document.getElementById('btnTipoFerie').classList.remove('active');
            document.getElementById('btnTipoPermesso').classList.remove('active');
            document.getElementById('alContainer').style.display = 'block';
        });

        document.getElementById('btnInviaRichiesta').addEventListener('click', function() {
            creaRichiesta();
        });
    });

    // ========================================
    // TAB APPROVAZIONI
    // ========================================
    function caricaApprovazioni() {
        fetch('/Responsabile/CongedoApi/GetRichiesteDaApprovare')
            .then(function(response) { return response.json(); })
            .then(function(richieste) {
                var container = document.getElementById('listaApprovazioni');

                if (richieste.length === 0) {
                    container.innerHTML =
                        '<div class="onit-card p-5 text-center">' +
                        '<i class="fa-solid fa-clipboard-check fa-3x text-muted mb-3"></i>' +
                        '<h4>Nessuna richiesta da approvare</h4>' +
                        '<p class="text-muted">Tutte le richieste sono state processate</p>' +
                        '</div>';
                    document.getElementById('badgeDaApprovare').style.display = 'none';
                } else {
                    container.innerHTML = '';
                    richieste.forEach(function(r) {
                        var tipoIcon = r.tipo === 'Ferie' ? 'fa-umbrella-beach' : (r.tipo === 'Permesso' ? 'fa-clock' : 'fa-virus');
                        var card = document.createElement('div');
                        card.className = 'onit-card p-3 mb-2 rend-card';
                        card.addEventListener('click', function() { apriModaleApprova(r); });
                        card.innerHTML =
                            '<div class="d-flex justify-content-between align-items-center">' +
                            '<div class="d-flex align-items-center gap-3">' +
                            '<div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width:45px;height:45px;">' +
                            '<i class="fa-solid ' + tipoIcon + ' text-primary fa-lg"></i></div>' +
                            '<div><h5 class="mb-0">' + r.dipendente + '</h5>' +
                            '<small class="text-muted"><i class="fa-solid ' + tipoIcon + '"></i> ' + r.tipo + ' · ' +
                            r.dataInizio + ' – ' + r.dataFine + ' · ' + r.giorni + ' giorn' + (r.giorni > 1 ? 'i' : 'o') + '</small></div></div>' +
                            '<div class="text-end"><span class="badge bg-warning text-dark">In attesa</span>' +
                            '<p class="text-muted small mb-0 mt-1">Richiesto il ' + r.dataRichiesta + '</p></div></div>';
                        container.appendChild(card);
                    });
                    document.getElementById('badgeDaApprovare').textContent = richieste.length;
                    document.getElementById('badgeDaApprovare').style.display = 'inline-block';
                }
            })
            .catch(function(err) { console.error('Errore caricamento approvazioni:', err); });
    }

    function apriModaleApprova(r) {
        document.getElementById('requestId').value = r.id;
        document.getElementById('modaleDipendente').textContent = r.dipendente;
        document.getElementById('modaleTipo').textContent = r.tipo;
        document.getElementById('modaleDal').textContent = r.dataInizio;
        document.getElementById('modaleAl').textContent = r.dataFine;
        document.getElementById('modaleGiorni').textContent = r.giorni + ' giorn' + (r.giorni > 1 ? 'i' : 'o');
        document.getElementById('modaleDataRichiesta').textContent = r.dataRichiesta;
        document.getElementById('modaleMotivo').textContent = r.motivo || 'Nessun motivo specificato';
        document.getElementById('noteRespingimento').value = '';
        document.getElementById('noteContainer').classList.add('d-none');
        new bootstrap.Modal(document.getElementById('modaleApprova')).show();
    }

    function approvaRichiesta() {
        var id = parseInt(document.getElementById('requestId').value);
        fetch('/Responsabile/CongedoApi/Approva', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(id)
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            alert(data.message || 'Approvata!');
            bootstrap.Modal.getInstance(document.getElementById('modaleApprova')).hide();
            caricaApprovazioni();
            caricaDatiGriglia();
        })
        .catch(function() { alert('Errore di connessione'); });
    }

    function respingiRichiesta() {
        var note = document.getElementById('noteRespingimento').value.trim();
        if (!note) {
            document.getElementById('noteContainer').classList.remove('d-none');
            document.getElementById('noteRespingimento').focus();
            alert('Inserisci il motivo del respingimento');
            return;
        }
        var id = parseInt(document.getElementById('requestId').value);
        fetch('/Responsabile/CongedoApi/Respingi', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id, note: note })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            alert(data.message || 'Respinta!');
            bootstrap.Modal.getInstance(document.getElementById('modaleApprova')).hide();
            caricaApprovazioni();
            caricaDatiGriglia();
        })
        .catch(function() { alert('Errore di connessione'); });
    }

    // ========================================
    // CALENDARIO AZIENDALE - GRIGLIA
    // ========================================
    var meseCorrenteGriglia = new Date();
    var datiRichiesteGriglia = [];
    var tuttiDipendenti = [];

    function inizializzaCalendarioAziendale() {
        // Carica i dati e genera la griglia
        caricaDatiGriglia();
        
        // Gestori navigazione mese
        document.getElementById('btnPrevMonth').addEventListener('click', function() {
            meseCorrenteGriglia.setMonth(meseCorrenteGriglia.getMonth() - 1);
            generaGriglia();
        });
        
        document.getElementById('btnNextMonth').addEventListener('click', function() {
            meseCorrenteGriglia.setMonth(meseCorrenteGriglia.getMonth() + 1);
            generaGriglia();
        });
    }

    function caricaDatiGriglia() {
        // Carica sia le richieste che la lista di tutti i dipendenti
        Promise.all([
            fetch('/Responsabile/CongedoApi/GetFerieTutti').then(res => res.json()),
            fetch('/Responsabile/CongedoApi/GetDipendenti').then(res => res.json())
        ])
        .then(function(results) {
            datiRichiesteGriglia = results[0];
            tuttiDipendenti = results[1];
            generaGriglia();
        })
        .catch(function(err) {
            console.error('Errore caricamento dati griglia:', err);
        });
    }

    function generaGriglia() {
        var anno = meseCorrenteGriglia.getFullYear();
        var mese = meseCorrenteGriglia.getMonth();
        
        // Aggiorna titolo mese
        var nomiMesi = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                        'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        document.getElementById('meseCorrente').textContent = nomiMesi[mese] + ' ' + anno;
        
        // Calcola numero giorni nel mese
        var primoGiorno = new Date(anno, mese, 1);
        var ultimoGiorno = new Date(anno, mese + 1, 0);
        var numGiorni = ultimoGiorno.getDate();
        
        // Genera header giorni
        var headerGiorni = document.getElementById('headerGiorni');
        headerGiorni.innerHTML = '<th class=\"col-dipendente\">Dipendente</th>';
        
        var nomiGiorniBrevi = ['DOM', 'LUN', 'MAR', 'MER', 'GIO', 'VEN', 'SAB'];
        
        for (var giorno = 1; giorno <= numGiorni; giorno++) {
            var data = new Date(anno, mese, giorno);
            var giornoSettimana = data.getDay();
            var nomeGiorno = nomiGiorniBrevi[giornoSettimana];
            var isWeekend = giornoSettimana === 0 || giornoSettimana === 6;
            
            var th = document.createElement('th');
            th.innerHTML = nomeGiorno + '<br>' + (giorno < 10 ? '0' + giorno : giorno);
            if (isWeekend) th.classList.add('giorno-weekend');
            headerGiorni.appendChild(th);
        }
        
        // Raggruppa richieste per dipendente
        var richiestePerDipendente = {};
        datiRichiesteGriglia.forEach(function(richiesta) {
            var dipendente = richiesta.extendedProps ? richiesta.extendedProps.dipendente : richiesta.dipendente || 'Sconosciuto';
            if (!richiestePerDipendente[dipendente]) {
                richiestePerDipendente[dipendente] = [];
            }
            richiestePerDipendente[dipendente].push(richiesta);
        });
        
        // Genera righe dipendenti
        var bodyGriglia = document.getElementById('bodyGriglia');
        bodyGriglia.innerHTML = '';
        
        if (tuttiDipendenti.length === 0) {
            var tr = document.createElement('tr');
            tr.innerHTML = '<td colspan=\"' + (numGiorni + 1) + '\" class=\"text-center text-muted py-4\">Nessun dipendente disponibile</td>';
            bodyGriglia.appendChild(tr);
            return;
        }
        
        // Usa la lista completa di tutti i dipendenti
        tuttiDipendenti.forEach(function(dipendente) {
            var tr = document.createElement('tr');
            
            // Colonna dipendente
            var tdNome = document.createElement('td');
            tdNome.className = 'col-dipendente';
            tdNome.textContent = dipendente.nomeCompleto;
            tr.appendChild(tdNome);
            
            // Colonne giorni
            for (var giorno = 1; giorno <= numGiorni; giorno++) {
                var data = new Date(anno, mese, giorno);
                var giornoSettimana = data.getDay();
                var isWeekend = giornoSettimana === 0 || giornoSettimana === 6;
                // Formatta data senza conversione UTC
                var dataStr = anno + '-' + 
                              (mese + 1 < 10 ? '0' : '') + (mese + 1) + '-' + 
                              (giorno < 10 ? '0' : '') + giorno;
                
                var td = document.createElement('td');
                if (isWeekend) td.classList.add('giorno-weekend');
                
                // Cerca richieste per questo giorno (può essere vuoto se non ha richieste)
                var richiesteDipendente = richiestePerDipendente[dipendente.nomeCompleto] || [];
                var richiestaGiorno = trovaRichiestaPerGiorno(richiesteDipendente, dataStr);
                
                if (richiestaGiorno) {
                    var tipo = richiestaGiorno.extendedProps ? richiestaGiorno.extendedProps.tipo : richiestaGiorno.tipo;
                    var stato = richiestaGiorno.extendedProps ? richiestaGiorno.extendedProps.stato : 'Approvato';
                    var lettera = tipo === 'Ferie' ? 'F' : (tipo === 'Permesso' ? 'P' : 'M');
                    var classe = tipo === 'Ferie' ? 'evento-ferie' : (tipo === 'Permesso' ? 'evento-permesso' : 'evento-malattia');
                    
                    td.innerHTML = '<span class=\"cella-evento ' + classe + '\">' + lettera + '</span>';
                    td.title = tipo + (stato === 'InAttesa' ? ' - In attesa di approvazione' : ' (Approvato)');
                }
                
                tr.appendChild(td);
            }
            
            bodyGriglia.appendChild(tr);
        });
    }

    function trovaRichiestaPerGiorno(richieste, dataStr) {
        for (var i = 0; i < richieste.length; i++) {
            var richiesta = richieste[i];
            var start = richiesta.start || richiesta.dataInizio;
            var end = richiesta.end || richiesta.dataFine;
            
            // Estrai solo la parte della data (YYYY-MM-DD) senza considerare l'ora
            var startStr = start.split('T')[0];
            var endStr = end ? end.split('T')[0] : startStr;
            
            // L'API restituisce end come data esclusiva (FullCalendar), quindi sottraiamo 1 giorno
            if (end) {
                var endDate = new Date(endStr + 'T00:00:00');
                endDate.setDate(endDate.getDate() - 1);
                endStr = endDate.getFullYear() + '-' + 
                         (endDate.getMonth() + 1 < 10 ? '0' : '') + (endDate.getMonth() + 1) + '-' + 
                         (endDate.getDate() < 10 ? '0' : '') + endDate.getDate();
            }
            
            // Confronto diretto tra stringhe YYYY-MM-DD
            if (dataStr >= startStr && dataStr <= endStr) {
                return richiesta;
            }
        }
        return null;
    }

    // ========================================
    // CALENDARIO MIO
    // ========================================
    function inizializzaCalendarioMio() {
        var el = document.getElementById('calendarioMio');
        calendarMio = new FullCalendar.Calendar(el, {
            initialView: 'month',
            locale: 'it',
            firstDay: 1, // Inizia dal lunedì
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,week'
            },
            dayCellClassNames: function(arg) {
                var dayOfWeek = arg.date.getDay();
                if (dayOfWeek === 6) return ['weekend-day', 'sabato'];
                if (dayOfWeek === 0) return ['weekend-day', 'domenica'];
                return [];
            },
            events: function(info, successCallback, failureCallback) {
                fetch('/Responsabile/CongedoApi/GetMieFerie')
                    .then(function(res) { return res.json(); })
                    .then(function(data) { successCallback(data); })
                    .catch(function(err) { failureCallback(err); });
            },
            eventDidMount: function(info) {
                var tipo = info.event.extendedProps.tipo;
                // Colori basati sul tipo: Ferie=verde, Permesso=giallo, Malattia=rosso
                if (tipo === 'Ferie') {
                    info.el.style.backgroundColor = '#28a745';
                    info.el.style.borderColor = '#28a745';
                } else if (tipo === 'Permesso') {
                    info.el.style.backgroundColor = '#ffc107';
                    info.el.style.borderColor = '#ffc107';
                } else if (tipo === 'Malattia') {
                    info.el.style.backgroundColor = '#dc3545';
                    info.el.style.borderColor = '#dc3545';
                }
                info.el.style.color = '#fff';
            },
            eventClick: function(info) {
                var p = info.event.extendedProps;
                alert('Tipo: ' + p.tipo + '\nStato: ' + p.stato + '\nMotivo: ' + (p.motivo || 'N/A'));
            },
            dateClick: function(info) {
                document.getElementById('creaDal').value = info.dateStr;
                document.getElementById('creaAl').value = info.dateStr;
                new bootstrap.Modal(document.getElementById('modaleCrea')).show();
            }
        });
        calendarMio.render();
    }

    // ========================================
    // MODALE CREA RICHIESTA
    // ========================================
    function apriModaleCrea() {
        document.getElementById('creaDal').value = '';
        document.getElementById('creaAl').value = '';
        document.getElementById('creaMotivo').value = '';
        tipoCorrente = 'Ferie';
        document.getElementById('btnTipoFerie').classList.add('active');
        document.getElementById('btnTipoPermesso').classList.remove('active');
        document.getElementById('btnTipoMalattia').classList.remove('active');
        document.getElementById('alContainer').style.display = 'block';
        new bootstrap.Modal(document.getElementById('modaleCrea')).show();
    }

    function creaRichiesta() {
        var dal = document.getElementById('creaDal').value;
        var al = tipoCorrente === 'Permesso' ? dal : document.getElementById('creaAl').value;
        var motivo = document.getElementById('creaMotivo').value.trim();

        if (!dal) { alert('Seleziona la data'); return; }
        if (tipoCorrente === 'Ferie' && !al) { alert('Seleziona la data di fine'); return; }

        fetch('/Responsabile/CongedoApi/Richiedi', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: null, tipo: tipoCorrente, dal: dal, al: al, motivo: motivo })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            alert(data.message || 'Richiesta inviata!');
            bootstrap.Modal.getInstance(document.getElementById('modaleCrea')).hide();
            if (calendarMio) calendarMio.refetchEvents();
            caricaDatiGriglia();
        })
        .catch(function() { alert('Errore di connessione'); });
    }

})();
</script>
}